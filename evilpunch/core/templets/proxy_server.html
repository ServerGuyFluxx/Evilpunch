{% extends 'base.html' %}
{% block title %}Proxy Server Â· EvilPunch{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Proxy Server</h1>
  <div>
    <span id="proxy-status" class="badge text-bg-secondary">Loading...</span>
  </div>
  </div>

<div class="card card-dark">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-auto">
        <label class="form-label">Port</label>
        <input type="number" class="form-control" id="proxy-port" value="443" min="1" max="65535" />
        <div class="form-text text-secondary">Falls back to HTTP on high ports if TLS certs are missing.</div>
      </div>
      <div class="col-auto">
        <button id="btn-start" class="btn btn-success">Start</button>
      </div>
      <div class="col-auto">
        <button id="btn-stop" class="btn btn-danger">Stop</button>
      </div>
      <div class="col-auto">
        <button id="btn-restart" class="btn btn-warning">Restart</button>
      </div>
    </div>
    <hr/>
    <pre id="proxy-log" class="mt-3 text-secondary" style="white-space: pre-wrap;"></pre>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const statusEl = document.getElementById('proxy-status');
  const logEl = document.getElementById('proxy-log');
  const portEl = document.getElementById('proxy-port');

  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  };
  const csrfToken = getCookie('csrftoken');

  const setStatus = (st) => {
    statusEl.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-secondary');
    if (st.running) {
      statusEl.classList.add('text-bg-success');
      statusEl.textContent = `Running (${st.scheme}) on port ${st.port}`;
    } else {
      statusEl.classList.add('text-bg-danger');
      statusEl.textContent = 'Stopped';
    }
  };

  const refreshStatus = async () => {
    const res = await fetch('{% url "proxy_status" %}');
    const data = await res.json();
    setStatus(data);
  };

  const call = async (url, body) => {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: body ? JSON.stringify(body) : '{}',
    });
    const data = await res.json();
    if (data.error) logEl.textContent = `[error] ${data.error}`;
    await refreshStatus();
  };

  document.getElementById('btn-start').addEventListener('click', async () => {
    await call('{% url "proxy_start" %}', {
      port: parseInt(portEl.value || '443', 10),
    });
  });

  document.getElementById('btn-stop').addEventListener('click', async () => {
    await call('{% url "proxy_stop" %}');
  });

  document.getElementById('btn-restart').addEventListener('click', async () => {
    await call('{% url "proxy_restart" %}', {
      port: parseInt(portEl.value || '443', 10),
    });
  });

  refreshStatus();
});
</script>
{% endblock %}


